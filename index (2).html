<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Site Survey App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            height: 35px;
            width: auto;
        }

        .header-title {
            display: flex;
            flex-direction: column;
        }

        .header h1 {
            font-size: 18px;
            margin: 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .header .area-name {
            font-size: 13px;
            opacity: 0.85;
            margin-top: 2px;
            font-weight: 400;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .section:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .section-header {
            font-size: 19px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #d4af37;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, #d4af37 0%, #b8941f 100%);
            border-radius: 2px;
        }

        .priority-high {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: white;
            padding: 14px;
            text-align: center;
            font-weight: 700;
            border-radius: 10px;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }

        .priority-controls {
            background: linear-gradient(135deg, #fff9e6 0%, #fff5d6 100%);
            border: 2px solid #d4af37;
        }

        .priority-misc {
            background: linear-gradient(135deg, #e8f5e9 0%, #d4edda 100%);
            border: 2px solid #2ecc71;
        }

        .priority-readings {
            background: linear-gradient(135deg, #fff4e6 0%, #ffe8cc 100%);
            border: 2px solid #f39c12;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            background: #fafafa;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #d4af37;
            background: white;
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.08);
        }

        select {
            background: white;
            cursor: pointer;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .photo-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .photo-placeholder {
            aspect-ratio: 1;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-placeholder:hover {
            background: #e8e8e8;
            border-color: #667eea;
        }

        .photo-placeholder svg {
            width: 40px;
            height: 40px;
            opacity: 0.5;
        }

        .photo-thumbnail {
            aspect-ratio: 1;
            background: #f0f0f0;
            border: 2px solid #d4af37;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }

        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-save {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: white;
        }

        .btn-save:active {
            background: linear-gradient(135deg, #b8941f 0%, #9c7d1a 100%);
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        .btn-next {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
        }

        .btn-next:active {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        .btn-prev {
            background: linear-gradient(135deg, #7f8c8d 0%, #5d6d7e 100%);
            color: white;
        }

        .btn-prev:active {
            background: linear-gradient(135deg, #5d6d7e 0%, #4a5a69 100%);
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        .btn-export {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-export:active {
            background: linear-gradient(135deg, #2980b9 0%, #2471a3 100%);
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            .row {
                grid-template-columns: 1fr;
            }
        }

        .reading-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .success-message {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .success-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fixture-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #f0f1f3 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }

        .fixture-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #d4af37;
        }

        .fixture-card-title {
            font-weight: 700;
            color: #1a1a2e;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-remove-fixture {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-remove-fixture:active {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: scale(0.95);
        }

        .btn-add-fixture {
            width: 100%;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
        }

        .btn-add-fixture:active {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            transform: scale(0.98);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo-container">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAcEAAABjCAYAAADjGLu5AAAACXBIWXMAAAsSAAALEgHS3X78AAALhklEQVR4nO3d7W3bSBCAYeZwDSgl2BDA/3EJdgkxoAbOJcQlOCVYDQiwS7BLiP4LIOIS4hJ0WGd0kXUkvUPukrs77wMEdwicWN7M7nC/hp/2+30FAIBFf/GvDgCwiiQIADCLJAgAMIskCAAwiyQIADCLJAgAMIskCAAwiyQIADCLJAgAMIskCAAwiyQIADCLJAgAMIskCAAwiyQIADCLJAgAMIskCAAwiyQIADCLJAgAMIskCAAw6+8pf/BmU59VVfWVcGv1vFzttj5faKQdXVtsl6vda6xvQDz2Ih7fc3H4slztnlP6UAfNpr6sqsr9OyzS+ES9kerbkybBqqq+VVX1z8TfMxfnis9pph2bTe06zKP7tVztXgL/9cRjN+KxRbOpq6N4fJzxc7gB/ktVVZfy3+wk0rfXn/b7/WRt12zqX5k8qUzNBcG17/c03I7f3a9QT5DEYyfi0Y8bxG+nmh02m/qLDOxfC2zvufr2xWR7gs2m/ocBp5N3JzLeju7p7ocMBqMQj72IRz8uDp+kDaJx8d5s6icX+5IES2zvOfq2W97eTnkw5nLC75WTV1kS8GW9Hc9k4Dkb+fdYb8cuxKPevSxPBtVs6kWzqe8k+Vlo56n79rqa6nSo+8fkAEKnR98lANrxP64d7of+YdqxF/E4zL20RxAyI/ohMyRLpuzbbw97U80EOXzQTbOfQDv+cTliGYp27EY8DrMI1R4S1z9kZmTRFH17eziMM1US5Gmx3YvyhBnt+N7QJSLasR3xOM7o9pDBf/BMqCCx+/b68D/Rk6Cs72Z5hHcC3gMO7dhKPejQjr2Ix3FGtQcJ8J3Yffu/WJ9iJsiSSbe14mtpxzBox27E40zkYA0JcBzfmHy37z3FZXm37no7wffJjvKCqO+T0Xc54ZeLM1n6mGr/g3jsoIzHktvxcAl9kqsIMoMZmgCf5b5iin1+MfFlftWBmINJL8tjGCmJ9OTxh92ejqbSRzKOnoRVA89ytftEWCE0OWV4p53xDolHuQOo2QN7lYfddczSY6HI+PUQs28rxsjX5Wr3+fg3KKCdB/Vmb27kQMaV8mOHLrUEvHHJZbna3SjvTKrjUfYBNQnQJb/z5WoXrLpKbFJR50o5W9W25aBZYEUSzMbgf+CcSMFmTSL3KvAMjBA7HjX3AG+Wq91tLsnv2AR9e/BEgSSYOEUJoOcIRWjnoLmnlmRFf5ilikfp27574S75ZbvSI6L0bW2ZtNPfJAmmz3epJOtZ4BHNU24pPzPKoI1H7xUet/xpLEZilO5rfYggCSZsSAmgAnjf88lxWQjZiRKPciLUd/Au5RRu8LYMMUaSBNPmezIti1NinqwlfaRNffnak/ceViHbHFWkvq0uk3aKJJg236ApYm9MUfHhdc4XmsIGxdvJh8Sj7+BN3+43+uQ8STBRiqDR1ntMGbNApCRKPMobInwOxNC3ewwtk3aKJJgu7xJABn/m3E/JIXEywPpeX9DO1ujb3WKU7uvdLiIJpsvUrEj5dMz9QMTmW71oyGyNvt1O27eDbBeRBBMkJYB8gmZbUEIovioO8tBs6nvFyU3V1QUpD+iTXOnbPRRj5Id7jCTBNFncG7O4RITESAL0jcWXARfY6dvdJj0QczDFWySgYPFuoPLpmHqhCE5mFnfKNx6o7u/Rt3t5V7wK3Y7BkqBsJE/1OpzcbBX3+HyD5rGghDCq4kMb4rGXdzwaaMcv0ue0r/tZx9wLNNi3tbPAwWXSToWcCT7wpulW2tcb+QZNKfeHFpGWS4jHdtp41OyPWbEdWMXF2t3AWH076ENzkD1B5X0Na7T3Xrwu5xa0Z6B5OtbMXojHdtp4JAG+9ypvc1BVaAp1py0zmqo4mr4ddEk51MEY3w9lUYzN3pLqZsbYIyEeu9GOw7k+dzXw1GbwhJCBGBWvvP9O3yXlUElQ9fZlQ2a595ILxUxDW0qJeGynjUfa8Y8xCbAyWiYtRt8O/tA8OgkqLkJapDnI8YUyaZ00S3jEYzdtPNKOvz3L29wHJUBFW5ZUEzfG3UDfMbLSjBkhDsawZNJt1iecDMQopUQ8dmM2rXcb4F1+FssBzno3ULOkHGI5lM7STnunjVJK7VjCCyNWPJbqUWZ/IV5mS99ul8R20aiZoOIipEWaJbyvBsukBX86Jh57aePRajuu5eBZkL05RVuWVBM3xlKo7xipXlIeuxzK8elumqWNGBdKUxfj6Zh47MaScretxFmMk5kWa+Imfzfw2NgkuCjlNFNgmooclFLqpl3CIx7bxYpHjRf5lYLDZ9kqqzmp0Ld7zVYm7dSoJLhc7a7H/Hm8sVgmLcrTMfE4nksIzaa+VrxKyNdCBr4Qe2y5CH6nLQPJl0k7xVsk5mexTBpvkE+Y7Kmca18T9AH3737XbOofcnDCAlNvRsmlTNopkuCMKJPWq6SqONlxbb9c7Vx9zAtZNgzFJUCXCO9k0CwSZdJ6zVom7RRJcF4WEwLvDcyIW15arnYXUjA6ZAx+k2RY6iEcyqR1m7VM2imS4LwslknzeTouqXJGEWQv7yLww4mLh4dmUz9IbJSEMmntZi+TdookOBPKpPUiASbIPWnL4aPrwCc9v8qs8FsJ7USZtF4xyqSN2i4iCc6HMmndSrozVRwZuC84ONOJMmndknurDklwPpRSaldS5YxicXCmF327XZJv1SEJzoAyab2YBWaEgzPvGS2TFqsEom9iHfUwQRKcB2XSurEfmKEJDs7kMiv0jfMiLsfLLHDOu4Gj440kOLGIF0pT/pljlUlDQiIfnPmZ+sGZiCXnkiQ/773nZ/OueDX1GEkSnJ5ms5cyacjO0cGZ24Cf/XBw5inhgzOaBFhC1Zx7xc8Ro4B7kO0ikuD0rN0NpEyaQXJw5rBEGjKWLw/XKRJcItXcdVw0mzrLd1+6dneneJUX2WNckA8yXpAEJ6S5UEqZNJRADs5cRTg4cyfJMKXXZ2lnd3e5XQeRxP1T+bN6X6VRjJFVqDFy7KuUoEOZtG7MAgvmZoXNpl7LElqofTM3YLrlURc7Nwn0GW3Vm4Uk8rXE/0tqWyCSpBeSmHxPbB77HmsWGKqtPu33+w+/SKa+Viq/a7igPff9+mZT//QMousSKknIU91Pjy91S2efFX8v8dhOFY9zkdnb/YABtc+rDLizvaqp2dS/DL+Rv83h+ow3xRjpHnqCnCH4cDlUUbrGIu9EpbxQSpm0DsRjryziRmYGJR6cocjDH+6h5ErzBzTl5kLGus+eoJkjvwPEOPFEmbR+xGO3bE7XFnpwhus9v70lwAHL07NsF5EEh9PeaTNVMSWBUkrWZHnHsrCDM+xr/34QuBp4dWGWN2/0JkFF6RqLtCWArF0Wn7OUkkVZPzzJrPA8QsWZp6kqzsgybxFXmwZ6W+YekgCV5eaCPmx8NBNM6fhxapIsAZSQGMu/xGO37GNHlkivZS8pRsWZKe7lhZ7R5uLWzehHLFPONkZ2ng6VJ6dfob9hIR6ls35I2Y6fS7gaIU91Dx5f6n16jHjs5R2POZEyaXeBP/KznCyMtuIiWwFPRk6KPksCHHwoSNm3B800+/TNBNl76ZbcO7ESE6NMGvHYrci9qKMl0tAHZ6LWIZVB+qrw06LPsvc3dP/v2KRl0k6RBPW0b4OmTFq3GO1oTUlvJ/8fKcrtEspN6IMz7k5arIMzR6+YuikoGW5lufdckl+oMWvWk/Oty6GKS84WrZer3Y3Pzx3rsnjKZN/Fp7K8ZkmZeOzmHY+5kwesO8WhK+82lCW9aCsxR+XADqemzxI+5PUqCe/w3xep/xm8fZR9+zzGMrZXxRgAAEpEAW0AgFkkQQCAWSRBAIBZJEEAgFkkQQCAWSRBAIBZJEEAgFkkQQCAWSRBAIBZJEEAgFkkQQCAWSRBAIBZJEEAgFkkQQCAWSRBAIBZJEEAgFkkQQCATVVV/QtZikQygSQfFQAAAABJRU5ErkJggg==" alt="Eneroi" class="logo">
                <div class="header-title">
                    <h1>Lighting Audit</h1>
                    <div class="area-name" id="areaDisplay">Area Name</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="success-message" id="successMessage">
            Survey saved successfully!
        </div>

        <!-- Basic Information -->
        <div class="section">
            <div class="section-header">Room Information</div>
            <div class="form-group">
                <label>Area Name</label>
                <input type="text" id="area" value="" placeholder="Enter area name">
            </div>
            <div class="form-group">
                <label>Room Name</label>
                <input type="text" id="roomName" placeholder="e.g., Pavilion Area">
            </div>
            <div class="row">
                <div class="form-group">
                    <label>Length (ft)</label>
                    <input type="number" step="0.1" id="length" placeholder="Length in feet" oninput="calculateArea()">
                </div>
                <div class="form-group">
                    <label>Width (ft)</label>
                    <input type="number" step="0.1" id="width" placeholder="Width in feet" oninput="calculateArea()">
                </div>
                <div class="form-group">
                    <label>Total Sq Ft</label>
                    <input type="number" step="0.1" id="sqft" placeholder="Auto-calculated" readonly style="background: #f9f9f9;">
                </div>
            </div>
            <div class="row">
                <div class="form-group">
                    <label>Room Notes</label>
                    <textarea id="roomNotes" placeholder="Additional notes about the room"></textarea>
                </div>
                <div class="form-group">
                    <label>Room Type</label>
                    <input type="text" id="roomType" placeholder="Room type">
                </div>
            </div>
        </div>

        <!-- Existing Fixture Details -->
        <div class="section">
            <div class="section-header">Existing Fixture Details</div>
            <div id="fixturesContainer"></div>
            <button type="button" class="btn-add-fixture" onclick="addFixture()">+ Add Another Fixture Type</button>
        </div>

        <!-- High Priority Section -->
        <div class="section">
            <div class="priority-high">High Priority</div>
            
            <div class="form-group">
                <label>Difficulty Factor</label>
                <select id="difficulty">
                    <option value="">Select difficulty</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                    <option value="very-hard">Very Hard</option>
                </select>
            </div>

            <div class="form-group">
                <label>Suggested Action</label>
                <select id="suggestedAction">
                    <option value="">Select action</option>
                    <option value="Retrofit">Retrofit</option>
                    <option value="Remove">Remove</option>
                    <option value="Replace">Replace</option>
                    <option value="Do Nothing">Do Nothing</option>
                </select>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="section priority-controls">
            <div class="section-header">Controls</div>
            
            <div class="form-group">
                <label>Voltage</label>
                <select id="voltage">
                    <option value="">Select voltage</option>
                    <option value="120-277v">120-277v</option>
                    <option value="277v-480v">277v-480v</option>
                </select>
            </div>

            <div class="form-group">
                <label>Existing Sensor</label>
                <select id="existingSensor">
                    <option value="">Select sensor type</option>
                    <option value="None">None</option>
                    <option value="Occupancy">Occupancy</option>
                    <option value="Daylight">Daylight</option>
                    <option value="Both">Both</option>
                </select>
            </div>

            <div class="form-group">
                <label>Control Notes</label>
                <textarea id="controlNotes" placeholder="Notes about controls"></textarea>
            </div>
        </div>

        <!-- Misc Section -->
        <div class="section priority-misc">
            <div class="section-header">Misc</div>
            
            <div class="row">
                <div class="form-group">
                    <label>Ceiling Type</label>
                    <input type="text" id="ceilingType" placeholder="Ceiling type">
                </div>
                <div class="form-group">
                    <label>Ceiling Height (ft)</label>
                    <input type="number" id="ceilingHeight" placeholder="Height in feet">
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Special Equipment</label>
                    <input type="text" id="specialEquipment" placeholder="Special equipment">
                </div>
                <div class="form-group">
                    <label>Fixture Height (ft)</label>
                    <input type="number" id="fixtureHeight" placeholder="Height in feet">
                </div>
            </div>

            <div class="form-group">
                <label>Fixture/Lamp Notes</label>
                <textarea id="fixtureLampNotes" placeholder="Additional notes"></textarea>
            </div>
        </div>

        <!-- FC Readings Section -->
        <div class="section priority-readings">
            <div class="section-header">Foot Candle Readings</div>
            
            <div class="reading-inputs">
                <div class="form-group">
                    <label>FC1 Reading</label>
                    <input type="number" step="0.01" id="fc1" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>FC2 Reading</label>
                    <input type="number" step="0.01" id="fc2" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>FC3 Reading</label>
                    <input type="number" step="0.01" id="fc3" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>FC4 Reading</label>
                    <input type="number" step="0.01" id="fc4" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>FC5 Reading</label>
                    <input type="number" step="0.01" id="fc5" placeholder="0.00">
                </div>
            </div>

            <div class="form-group">
                <label>Average FC Reading</label>
                <input type="number" step="0.01" id="avgFC" placeholder="Auto-calculated" readonly style="background: #f9f9f9;">
            </div>
        </div>

        <!-- Photos Section -->
        <div class="section">
            <div class="section-header">Photos</div>
            <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;" multiple>
            <div class="photo-section" id="photoGallery">
                <div class="photo-placeholder" onclick="document.getElementById('photoInput').click()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                    <div style="margin-top: 10px; font-size: 12px;">Tap to Add Photo</div>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="btn btn-prev" onclick="previousRoom()">‚Üê Previous</button>
        <button class="btn btn-save" onclick="saveSurvey()">üíæ Save</button>
        <button class="btn btn-export" onclick="exportToCSV()">üìä Export CSV</button>
        <button class="btn btn-next" onclick="nextRoom()">Next ‚Üí</button>
    </div>

    <script>
        let fixtureCount = 0;
        let autoSaveInterval;
        let currentDraft = null;
        let currentPhotos = [];

        // Initialize with one fixture
        document.addEventListener('DOMContentLoaded', function() {
            addFixture();
            initializeAutoSave();
            checkForDraft();
            setupBeforeUnloadWarning();
            setupPhotoCapture();
        });

        // Setup photo capture functionality
        function setupPhotoCapture() {
            const photoInput = document.getElementById('photoInput');
            photoInput.addEventListener('change', handlePhotoSelect);
        }

        // Handle photo selection
        function handlePhotoSelect(event) {
            const files = event.target.files;
            if (!files.length) return;

            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addPhotoToGallery(e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Reset input so same file can be selected again
            event.target.value = '';
        }

        // Add photo to gallery
        function addPhotoToGallery(dataUrl) {
            currentPhotos.push(dataUrl);
            updatePhotoGallery();
            saveDraft(); // Auto-save when photo is added
        }

        // Remove photo from gallery
        function removePhoto(index) {
            currentPhotos.splice(index, 1);
            updatePhotoGallery();
            saveDraft();
        }

        // Update photo gallery display
        function updatePhotoGallery() {
            const gallery = document.getElementById('photoGallery');
            
            // Clear existing photos except the add button
            gallery.innerHTML = '';

            // Add existing photos
            currentPhotos.forEach((photoData, index) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-thumbnail';
                photoDiv.innerHTML = `
                    <img src="${photoData}" alt="Photo ${index + 1}">
                    <button class="photo-remove" onclick="removePhoto(${index})" type="button">√ó</button>
                `;
                gallery.appendChild(photoDiv);
            });

            // Add the "add photo" button
            const addButton = document.createElement('div');
            addButton.className = 'photo-placeholder';
            addButton.onclick = () => document.getElementById('photoInput').click();
            addButton.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                    <circle cx="12" cy="13" r="4"></circle>
                </svg>
                <div style="margin-top: 10px; font-size: 12px;">Tap to Add Photo</div>
            `;
            gallery.appendChild(addButton);
        }

        // Auto-save draft every 30 seconds
        function initializeAutoSave() {
            autoSaveInterval = setInterval(() => {
                saveDraft();
            }, 30000); // Save every 30 seconds
        }

        // Save current form state as draft
        function saveDraft() {
            try {
                const draftData = collectFormData();
                localStorage.setItem('currentDraft', JSON.stringify(draftData));
                localStorage.setItem('lastAutoSave', new Date().toISOString());
                console.log('Draft auto-saved at', new Date().toLocaleTimeString());
            } catch (error) {
                console.error('Error saving draft:', error);
            }
        }

        // Check for existing draft on load
        function checkForDraft() {
            try {
                const draft = localStorage.getItem('currentDraft');
                if (draft) {
                    const lastSave = localStorage.getItem('lastAutoSave');
                    const shouldRestore = confirm(
                        `Found unsaved work from ${new Date(lastSave).toLocaleString()}. Would you like to restore it?`
                    );
                    
                    if (shouldRestore) {
                        restoreDraft(JSON.parse(draft));
                    } else {
                        localStorage.removeItem('currentDraft');
                        localStorage.removeItem('lastAutoSave');
                    }
                }
            } catch (error) {
                console.error('Error checking for draft:', error);
            }
        }

        // Restore draft data to form
        function restoreDraft(draftData) {
            try {
                // Restore basic fields
                Object.keys(draftData).forEach(key => {
                    if (key !== 'fixtures' && key !== 'timestamp') {
                        const element = document.getElementById(key);
                        if (element && draftData[key]) {
                            element.value = draftData[key];
                        }
                    }
                });

                // Restore fixtures
                if (draftData.fixtures && draftData.fixtures.length > 0) {
                    // Clear existing fixtures
                    document.getElementById('fixturesContainer').innerHTML = '';
                    fixtureCount = 0;

                    // Add each fixture back
                    draftData.fixtures.forEach((fixture, index) => {
                        addFixture();
                        const id = fixtureCount;
                        
                        // Restore fixture data
                        Object.keys(fixture).forEach(key => {
                            const element = document.getElementById(`${key}-${id}`);
                            if (element && fixture[key]) {
                                element.value = fixture[key];
                            }
                        });
                    });
                }

                // Recalculate area if needed
                calculateArea();
                calculateAverage();

                // Restore photos
                if (draftData.photos && draftData.photos.length > 0) {
                    currentPhotos = draftData.photos;
                    updatePhotoGallery();
                }

                showMessage('Draft restored successfully!', 'success');
            } catch (error) {
                console.error('Error restoring draft:', error);
                showMessage('Error restoring draft. Please check your data.', 'error');
            }
        }

        // Warn user before leaving page with unsaved changes
        function setupBeforeUnloadWarning() {
            window.addEventListener('beforeunload', function(e) {
                const draft = localStorage.getItem('currentDraft');
                if (draft) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });
        }

        // Collect all form data
        function collectFormData() {
            return {
                area: document.getElementById('area').value,
                roomName: document.getElementById('roomName').value,
                length: document.getElementById('length').value,
                width: document.getElementById('width').value,
                sqft: document.getElementById('sqft').value,
                roomNotes: document.getElementById('roomNotes').value,
                roomType: document.getElementById('roomType').value,
                fixtures: getAllFixtures(),
                difficulty: document.getElementById('difficulty').value,
                suggestedAction: document.getElementById('suggestedAction').value,
                voltage: document.getElementById('voltage').value,
                existingSensor: document.getElementById('existingSensor').value,
                controlNotes: document.getElementById('controlNotes').value,
                ceilingType: document.getElementById('ceilingType').value,
                ceilingHeight: document.getElementById('ceilingHeight').value,
                specialEquipment: document.getElementById('specialEquipment').value,
                fixtureHeight: document.getElementById('fixtureHeight').value,
                fixtureLampNotes: document.getElementById('fixtureLampNotes').value,
                fc1: document.getElementById('fc1').value,
                fc2: document.getElementById('fc2').value,
                fc3: document.getElementById('fc3').value,
                fc4: document.getElementById('fc4').value,
                fc5: document.getElementById('fc5').value,
                avgFC: document.getElementById('avgFC').value,
                photos: currentPhotos,
                timestamp: new Date().toISOString()
            };
        }

        function calculateArea() {
            const length = parseFloat(document.getElementById('length').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const sqft = length * width;
            document.getElementById('sqft').value = sqft > 0 ? sqft.toFixed(1) : '';
        }

        function addFixture() {
            fixtureCount++;
            const container = document.getElementById('fixturesContainer');
            
            const fixtureCard = document.createElement('div');
            fixtureCard.className = 'fixture-card';
            fixtureCard.id = `fixture-${fixtureCount}`;
            
            fixtureCard.innerHTML = `
                <div class="fixture-card-header">
                    <div class="fixture-card-title">Fixture Type ${fixtureCount}</div>
                    ${fixtureCount > 1 ? `<button type="button" class="btn-remove-fixture" onclick="removeFixture(${fixtureCount})">Remove</button>` : ''}
                </div>

                <div class="form-group">
                    <label>Quantity of This Fixture Type</label>
                    <input type="number" id="quantity-${fixtureCount}" placeholder="Number of fixtures" min="0">
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Lamp Type</label>
                        <select id="lampType-${fixtureCount}">
                            <option value="">Select lamp type</option>
                            <option value="Circle Fluorescent">Circle Fluorescent</option>
                            <option value="Compact Fluorescent">Compact Fluorescent</option>
                            <option value="Halogen Incandescent">Halogen Incandescent</option>
                            <option value="HPS">HPS</option>
                            <option value="LED">LED</option>
                            <option value="Linear Fluorescent">Linear Fluorescent</option>
                            <option value="Linear LED">Linear LED</option>
                            <option value="Mercury Vapor">Mercury Vapor</option>
                            <option value="Metal Halide">Metal Halide</option>
                            <option value="QL Induction">QL Induction</option>
                            <option value="Quartz">Quartz</option>
                            <option value="Standard Incadescent">Standard Incadescent</option>
                            <option value="U-Tube Fluorescent">U-Tube Fluorescent</option>
                            <option value="No Existing">No Existing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Lamp Shape</label>
                        <select id="lampShape-${fixtureCount}">
                            <option value="">Select lamp shape</option>
                            <option value="T12">T12</option>
                            <option value="T8">T8</option>
                            <option value="T5">T5</option>
                            <option value="LED">LED</option>
                            <option value="MH">MH</option>
                            <option value="HPS">HPS</option>
                            <option value="CFL">CFL</option>
                            <option value="U">U</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Bulb Wattage</label>
                        <select id="bulbWattage-${fixtureCount}">
                            <option value="">Select wattage</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="17">17</option>
                            <option value="20">20</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="28">28</option>
                            <option value="30">30</option>
                            <option value="32">32</option>
                            <option value="34">34</option>
                            <option value="36">36</option>
                            <option value="40">40</option>
                            <option value="48">48</option>
                            <option value="54">54</option>
                            <option value="60">60</option>
                            <option value="72">72</option>
                            <option value="96">96</option>
                            <option value="100">100</option>
                            <option value="150">150</option>
                            <option value="175">175</option>
                            <option value="200">200</option>
                            <option value="225">225</option>
                            <option value="250">250</option>
                            <option value="320">320</option>
                            <option value="350">350</option>
                            <option value="400">400</option>
                            <option value="600">600</option>
                            <option value="750">750</option>
                            <option value="1000">1000</option>
                            <option value="1500">1500</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label># of Bulbs</label>
                        <select id="numBulbs-${fixtureCount}">
                            <option value="">Select quantity</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Fixture Type</label>
                        <select id="fixtureType-${fixtureCount}">
                            <option value="">Select fixture type</option>
                            <option value="Indirect">Indirect</option>
                            <option value="High Bay">High Bay</option>
                            <option value="Industrial Strip">Industrial Strip</option>
                            <option value="Troffer">Troffer</option>
                            <option value="Strip">Strip</option>
                            <option value="Vapor Tight">Vapor Tight</option>
                            <option value="Flood">Flood</option>
                            <option value="Pendant">Pendant</option>
                            <option value="Vanity">Vanity</option>
                            <option value="Wrap">Wrap</option>
                            <option value="Shoe Box">Shoe Box</option>
                            <option value="Lantern">Lantern</option>
                            <option value="Wall Pack">Wall Pack</option>
                            <option value="Sports">Sports</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fixture Size</label>
                        <select id="fixtureSize-${fixtureCount}">
                            <option value="">Select size</option>
                            <option value="1x2">1x2</option>
                            <option value="1x4">1x4</option>
                            <option value="2x2">2x2</option>
                            <option value="2x4">2x4</option>
                            <option value="4 foot">4 foot</option>
                            <option value="8 foot">8 foot</option>
                            <option value="12 foot">12 foot</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Lens Type</label>
                        <select id="lensType-${fixtureCount}">
                            <option value="">Select lens type</option>
                            <option value="Center Basket">Center Basket</option>
                            <option value="Diffused">Diffused</option>
                            <option value="Louver">Louver</option>
                            <option value="Parabolic">Parabolic</option>
                            <option value="Prismatic">Prismatic</option>
                            <option value="Clear">Clear</option>
                            <option value="Wire Cage">Wire Cage</option>
                            <option value="No Lens">No Lens</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Mounting</label>
                        <select id="mounting-${fixtureCount}">
                            <option value="">Select mounting</option>
                            <option value="Aircraft Cable">Aircraft Cable</option>
                            <option value="Chain">Chain</option>
                            <option value="Pendant">Pendant</option>
                            <option value="Surface">Surface</option>
                            <option value="Recessed">Recessed</option>
                            <option value="Wall">Wall</option>
                            <option value="Slip Fitter">Slip Fitter</option>
                            <option value="Tennon">Tennon</option>
                            <option value="Arm">Arm</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="form-group">
                        <label>Kelvin</label>
                        <select id="kelvin-${fixtureCount}">
                            <option value="">Select color temperature</option>
                            <option value="3000">3000K</option>
                            <option value="3500">3500K</option>
                            <option value="4000">4000K</option>
                            <option value="4100">4100K</option>
                            <option value="5000">5000K</option>
                            <option value="5700">5700K</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Emergency Backup</label>
                        <select id="emergencyBackup-${fixtureCount}">
                            <option value="">Select option</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                </div>
            `;
            
            container.appendChild(fixtureCard);
        }

        function removeFixture(id) {
            const fixture = document.getElementById(`fixture-${id}`);
            if (fixture) {
                fixture.remove();
                saveDraft(); // Auto-save after removing fixture
            }
        }

        function getAllFixtures() {
            const fixtures = [];
            const container = document.getElementById('fixturesContainer');
            const fixtureCards = container.querySelectorAll('.fixture-card');
            
            fixtureCards.forEach((card) => {
                const id = card.id.split('-')[1];
                const quantity = document.getElementById(`quantity-${id}`)?.value;
                
                // Include all fixtures (even without quantity for draft purposes)
                fixtures.push({
                    quantity: quantity || '',
                    lampType: document.getElementById(`lampType-${id}`)?.value || '',
                    lampShape: document.getElementById(`lampShape-${id}`)?.value || '',
                    bulbWattage: document.getElementById(`bulbWattage-${id}`)?.value || '',
                    numBulbs: document.getElementById(`numBulbs-${id}`)?.value || '',
                    fixtureType: document.getElementById(`fixtureType-${id}`)?.value || '',
                    fixtureSize: document.getElementById(`fixtureSize-${id}`)?.value || '',
                    lensType: document.getElementById(`lensType-${id}`)?.value || '',
                    mounting: document.getElementById(`mounting-${id}`)?.value || '',
                    kelvin: document.getElementById(`kelvin-${id}`)?.value || '',
                    emergencyBackup: document.getElementById(`emergencyBackup-${id}`)?.value || ''
                });
            });
            
            return fixtures;
        }

        // Auto-calculate average FC reading
        function calculateAverage() {
            const fc1 = parseFloat(document.getElementById('fc1').value) || 0;
            const fc2 = parseFloat(document.getElementById('fc2').value) || 0;
            const fc3 = parseFloat(document.getElementById('fc3').value) || 0;
            const fc4 = parseFloat(document.getElementById('fc4').value) || 0;
            const fc5 = parseFloat(document.getElementById('fc5').value) || 0;
            
            const values = [fc1, fc2, fc3, fc4, fc5].filter(v => v > 0);
            const avg = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
            
            document.getElementById('avgFC').value = avg.toFixed(3);
        }

        // Add event listeners to FC inputs
        ['fc1', 'fc2', 'fc3', 'fc4', 'fc5'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateAverage);
        });

        // Update area display when area name changes
        document.getElementById('area').addEventListener('input', function() {
            document.getElementById('areaDisplay').textContent = this.value || 'Lighting Audit';
        });

        // Show success or error messages
        function showMessage(message, type = 'success') {
            const successMsg = document.getElementById('successMessage');
            successMsg.textContent = message;
            successMsg.style.background = type === 'success' ? '#51cf66' : '#ff6b6b';
            successMsg.classList.add('show');
            setTimeout(() => successMsg.classList.remove('show'), 3000);
        }

        function saveSurvey() {
            try {
                // Collect all form data
                const surveyData = collectFormData();

                // Validate that we have at least some data
                if (!surveyData.area && !surveyData.roomName) {
                    showMessage('Please enter at least an area or room name', 'error');
                    return false;
                }

                // Get existing surveys with error handling
                let surveys = [];
                try {
                    surveys = JSON.parse(localStorage.getItem('surveys') || '[]');
                } catch (e) {
                    console.error('Error reading surveys:', e);
                    surveys = [];
                }

                // Add new survey
                surveys.push(surveyData);
                
                // Save with error handling
                try {
                    localStorage.setItem('surveys', JSON.stringify(surveys));
                    
                    // Create backup
                    localStorage.setItem('surveys_backup', JSON.stringify(surveys));
                    localStorage.setItem('last_backup', new Date().toISOString());
                    
                    // Clear the draft since we saved successfully
                    localStorage.removeItem('currentDraft');
                    localStorage.removeItem('lastAutoSave');
                    
                    showMessage('Survey saved successfully!', 'success');
                    
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    console.log('Survey saved:', surveyData);
                    return true;
                } catch (e) {
                    console.error('Error saving survey:', e);
                    showMessage('Error saving survey. Storage may be full.', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Unexpected error:', error);
                showMessage('An unexpected error occurred. Please try again.', 'error');
                return false;
            }
        }

        function nextRoom() {
            const saved = saveSurvey();
            if (!saved) return;
            
            // Clear form for next room
            setTimeout(() => {
                document.querySelectorAll('input:not([readonly]), select, textarea').forEach(input => {
                    if (input.id !== 'area') {
                        input.value = '';
                    }
                });
                // Reset fixtures to just one
                document.getElementById('fixturesContainer').innerHTML = '';
                fixtureCount = 0;
                addFixture();
                
                // Clear photos
                currentPhotos = [];
                updatePhotoGallery();
            }, 500);
        }

        function previousRoom() {
            try {
                // Load previous survey from localStorage
                const surveys = JSON.parse(localStorage.getItem('surveys') || '[]');
                if (surveys.length > 0) {
                    const lastSurvey = surveys[surveys.length - 1];
                    restoreDraft(lastSurvey);
                } else {
                    showMessage('No previous surveys found', 'error');
                }
            } catch (error) {
                console.error('Error loading previous room:', error);
                showMessage('Error loading previous survey', 'error');
            }
        }

        // Export surveys to CSV
        function exportToCSV() {
            try {
                const surveys = JSON.parse(localStorage.getItem('surveys') || '[]');
                
                if (surveys.length === 0) {
                    alert('No surveys to export. Please save at least one survey first.');
                    return;
                }
                
                // CSV Headers
                const headers = [
                    'Timestamp',
                    'Area Name',
                    'Room Name',
                    'Length (ft)',
                    'Width (ft)',
                    'Total Sq Ft',
                    'Room Notes',
                    'Room Type',
                    'Fixture #',
                    'Fixture Quantity',
                    'Lamp Type',
                    'Lamp Shape',
                    'Bulb Wattage',
                    '# of Bulbs',
                    'Fixture Type',
                    'Fixture Size',
                    'Lens Type',
                    'Mounting',
                    'Kelvin',
                    'Emergency Backup',
                    'Difficulty Factor',
                    'Suggested Action',
                    'Voltage',
                    'Existing Sensor',
                    'Control Notes',
                    'Ceiling Type',
                    'Ceiling Height (ft)',
                    'Special Equipment',
                    'Fixture Height (ft)',
                    'Fixture/Lamp Notes',
                    'FC1 Reading',
                    'FC2 Reading',
                    'FC3 Reading',
                    'FC4 Reading',
                    'FC5 Reading',
                    'Average FC'
                ];
                
                let csvContent = headers.join(',') + '\n';
                
                // Process each survey
                surveys.forEach(survey => {
                    const baseData = [
                        formatCSVField(survey.timestamp),
                        formatCSVField(survey.area),
                        formatCSVField(survey.roomName),
                        formatCSVField(survey.length),
                        formatCSVField(survey.width),
                        formatCSVField(survey.sqft),
                        formatCSVField(survey.roomNotes),
                        formatCSVField(survey.roomType)
                    ];
                    
                    // If there are fixtures, create a row for each fixture
                    if (survey.fixtures && survey.fixtures.length > 0) {
                        survey.fixtures.forEach((fixture, index) => {
                            const fixtureData = [
                                ...baseData,
                                index + 1, // Fixture number
                                formatCSVField(fixture.quantity),
                                formatCSVField(fixture.lampType),
                                formatCSVField(fixture.lampShape),
                                formatCSVField(fixture.bulbWattage),
                                formatCSVField(fixture.numBulbs),
                                formatCSVField(fixture.fixtureType),
                                formatCSVField(fixture.fixtureSize),
                                formatCSVField(fixture.lensType),
                                formatCSVField(fixture.mounting),
                                formatCSVField(fixture.kelvin),
                                formatCSVField(fixture.emergencyBackup),
                                formatCSVField(survey.difficulty),
                                formatCSVField(survey.suggestedAction),
                                formatCSVField(survey.voltage),
                                formatCSVField(survey.existingSensor),
                                formatCSVField(survey.controlNotes),
                                formatCSVField(survey.ceilingType),
                                formatCSVField(survey.ceilingHeight),
                                formatCSVField(survey.specialEquipment),
                                formatCSVField(survey.fixtureHeight),
                                formatCSVField(survey.fixtureLampNotes),
                                formatCSVField(survey.fc1),
                                formatCSVField(survey.fc2),
                                formatCSVField(survey.fc3),
                                formatCSVField(survey.fc4),
                                formatCSVField(survey.fc5),
                                formatCSVField(survey.avgFC)
                            ];
                            csvContent += fixtureData.join(',') + '\n';
                        });
                    } else {
                        // No fixtures - create one row with empty fixture fields
                        const rowData = [
                            ...baseData,
                            '', '', '', '', '', '', '', '', '', '', '', '',
                            formatCSVField(survey.difficulty),
                            formatCSVField(survey.suggestedAction),
                            formatCSVField(survey.voltage),
                            formatCSVField(survey.existingSensor),
                            formatCSVField(survey.controlNotes),
                            formatCSVField(survey.ceilingType),
                            formatCSVField(survey.ceilingHeight),
                            formatCSVField(survey.specialEquipment),
                            formatCSVField(survey.fixtureHeight),
                            formatCSVField(survey.fixtureLampNotes),
                            formatCSVField(survey.fc1),
                            formatCSVField(survey.fc2),
                            formatCSVField(survey.fc3),
                            formatCSVField(survey.fc4),
                            formatCSVField(survey.fc5),
                            formatCSVField(survey.avgFC)
                        ];
                        csvContent += rowData.join(',') + '\n';
                    }
                });
                
                // Create and download CSV file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `site-surveys-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage(`Exported ${surveys.length} surveys to CSV!`, 'success');
            } catch (error) {
                console.error('Error exporting to CSV:', error);
                showMessage('Error exporting to CSV. Please try again.', 'error');
            }
        }
        
        // Format field for CSV (handle commas and quotes)
        function formatCSVField(value) {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            
            // Convert to string
            let stringValue = String(value);
            
            // If contains comma, newline, or quote, wrap in quotes and escape quotes
            if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('"')) {
                stringValue = '"' + stringValue.replace(/"/g, '""') + '"';
            }
            
            return stringValue;
        }

        // Export surveys to JSON
        function exportSurveys() {
            try {
                const surveys = JSON.parse(localStorage.getItem('surveys') || '[]');
                
                if (surveys.length === 0) {
                    alert('No surveys to export');
                    return;
                }
                
                const dataStr = JSON.stringify(surveys, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `site-surveys-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showMessage(`Exported ${surveys.length} surveys successfully!`, 'success');
            } catch (error) {
                console.error('Error exporting surveys:', error);
                showMessage('Error exporting surveys', 'error');
            }
        }

        // Recovery function in case of data corruption
        function recoverFromBackup() {
            try {
                const backup = localStorage.getItem('surveys_backup');
                if (backup) {
                    localStorage.setItem('surveys', backup);
                    showMessage('Data recovered from backup!', 'success');
                    location.reload();
                } else {
                    showMessage('No backup found', 'error');
                }
            } catch (error) {
                console.error('Error recovering backup:', error);
                showMessage('Error recovering backup', 'error');
            }
        }

        // Add export button (you can add this to the UI if needed)
        console.log('Available functions:');
        console.log('- exportToCSV() - Export all surveys to CSV (also available as button)');
        console.log('- exportSurveys() - Export all surveys to JSON');
        console.log('- recoverFromBackup() - Restore from last backup');
        console.log('- saveDraft() - Manually save current work');
    </script>
</body>
</html>
